import {_obj_assign} from './core/_common.jsy'
import {_ao_fence_loop, ao_fence_fn, ao_fence_v} from './core.jsy'

export function ao_queue(xform) ::
  let [fence, out_reset] = ao_fence_fn()
  let [in_fence, in_reset] = ao_fence_v()

  let ag_out = _ao_fence_loop(fence, in_reset)
  let g_in = _ao_fence_loop(in_fence, out_reset, xform)

  // allow g_in to initialize
  g_in.next() ; in_reset()
  return _obj_assign @ ag_out, {fence, g_in}
